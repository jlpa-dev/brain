{
    "componentChunkName": "component---src-templates-article-js",
    "path": "/articles/008-guardar-restaurar-dependencias-postgresql/",
    "result": {"data":{"site":{"siteMetadata":{"title":"JLPA | BLOG"}},"markdownRemark":{"id":"5fe2a75d-0a58-5fc2-885b-ba9b41716ec3","excerpt":"Modo de uso deps_save_and_drop_dependencies(nombre_de_schema, nombre_de_tabla)\ndeps_restore_dependencies(nombre_de_shema, nombre_de_tabla) Fuente:\nhttps://gistâ€¦","html":"<!-- Guardar / Restaurar despendencias Postgresql https://gist.github.com/mateuszwenus/11187288 -->\n<pre><code class=\"language-postgresql\">create table deps_saved_ddl\n\n(\n\ndeps_id serial primary key,\n\ndeps_view_schema varchar(255),\n\ndeps_view_name varchar(255),\n\ndeps_ddl_to_run text\n\n);\n\ncreate or replace function deps_save_and_drop_dependencies(p_view_schema varchar, p_view_name varchar) returns void as\n\n$$\n\ndeclare\n\nv_curr record;\n\nbegin\n\nfor v_curr in\n\n(\n\nselect obj_schema, obj_name, obj_type from\n\n(\n\nwith recursive recursive_deps(obj_schema, obj_name, obj_type, depth) as\n\n(\n\nselect p_view_schema, p_view_name, null::varchar, 0\n\nunion\n\nselect dep_schema::varchar, dep_name::varchar, dep_type::varchar, recursive_deps.depth + 1 from\n\n(\n\nselect ref_nsp.nspname ref_schema, ref_cl.relname ref_name,\n\nrwr_cl.relkind dep_type,\n\nrwr_nsp.nspname dep_schema,\n\nrwr_cl.relname dep_name\n\nfrom pg_depend dep\n\njoin pg_class ref_cl on dep.refobjid = ref_cl.oid\n\njoin pg_namespace ref_nsp on ref_cl.relnamespace = ref_nsp.oid\n\njoin pg_rewrite rwr on dep.objid = rwr.oid\n\njoin pg_class rwr_cl on rwr.ev_class = rwr_cl.oid\n\njoin pg_namespace rwr_nsp on rwr_cl.relnamespace = rwr_nsp.oid\n\nwhere dep.deptype = 'n'\n\nand dep.classid = 'pg_rewrite'::regclass\n\n) deps\n\njoin recursive_deps on deps.ref_schema = recursive_deps.obj_schema and deps.ref_name = recursive_deps.obj_name\n\nwhere (deps.ref_schema != deps.dep_schema or deps.ref_name != deps.dep_name)\n\n)\n\nselect obj_schema, obj_name, obj_type, depth\n\nfrom recursive_deps\n\nwhere depth > 0\n\n) t\n\ngroup by obj_schema, obj_name, obj_type\n\norder by max(depth) desc\n\n) loop\n\ninsert into deps_saved_ddl(deps_view_schema, deps_view_name, deps_ddl_to_run)\n\nselect p_view_schema, p_view_name, 'COMMENT ON ' ||\n\ncase\n\nwhen c.relkind = 'v' then 'VIEW'\n\nwhen c.relkind = 'm' then 'MATERIALIZED VIEW'\n\nelse ''\n\nend\n\n|| ' ' || n.nspname || '.' || c.relname || ' IS ''' || replace(d.description, '''', '''''') || ''';'\n\nfrom pg_class c\n\njoin pg_namespace n on n.oid = c.relnamespace\n\njoin pg_description d on d.objoid = c.oid and d.objsubid = 0\n\nwhere n.nspname = v_curr.obj_schema and c.relname = v_curr.obj_name and d.description is not null;\n\ninsert into deps_saved_ddl(deps_view_schema, deps_view_name, deps_ddl_to_run)\n\nselect p_view_schema, p_view_name, 'COMMENT ON COLUMN ' || n.nspname || '.' || c.relname || '.' || a.attname || ' IS ''' || replace(d.description, '''', '''''') || ''';'\n\nfrom pg_class c\n\njoin pg_attribute a on c.oid = a.attrelid\n\njoin pg_namespace n on n.oid = c.relnamespace\n\njoin pg_description d on d.objoid = c.oid and d.objsubid = a.attnum\n\nwhere n.nspname = v_curr.obj_schema and c.relname = v_curr.obj_name and d.description is not null;\n\ninsert into deps_saved_ddl(deps_view_schema, deps_view_name, deps_ddl_to_run)\n\nselect p_view_schema, p_view_name, 'GRANT ' || privilege_type || ' ON ' || table_schema || '.' || table_name || ' TO ' || grantee\n\nfrom information_schema.role_table_grants\n\nwhere table_schema = v_curr.obj_schema and table_name = v_curr.obj_name;\n\nif v_curr.obj_type = 'v' then\n\ninsert into deps_saved_ddl(deps_view_schema, deps_view_name, deps_ddl_to_run)\n\nselect p_view_schema, p_view_name, 'CREATE VIEW ' || v_curr.obj_schema || '.' || v_curr.obj_name || ' AS ' || view_definition\n\nfrom information_schema.views\n\nwhere table_schema = v_curr.obj_schema and table_name = v_curr.obj_name;\n\nelsif v_curr.obj_type = 'm' then\n\ninsert into deps_saved_ddl(deps_view_schema, deps_view_name, deps_ddl_to_run)\n\nselect p_view_schema, p_view_name, 'CREATE MATERIALIZED VIEW ' || v_curr.obj_schema || '.' || v_curr.obj_name || ' AS ' || definition\n\nfrom pg_matviews\n\nwhere schemaname = v_curr.obj_schema and matviewname = v_curr.obj_name;\n\nend if;\n\nexecute 'DROP ' ||\n\ncase\n\nwhen v_curr.obj_type = 'v' then 'VIEW'\n\nwhen v_curr.obj_type = 'm' then 'MATERIALIZED VIEW'\n\nend\n\n|| ' ' || v_curr.obj_schema || '.' || v_curr.obj_name;\n\nend loop;\n\nend;\n\n$$\n\nLANGUAGE plpgsql;\n\ncreate or replace function deps_restore_dependencies(p_view_schema varchar, p_view_name varchar) returns void as\n\n$$\n\ndeclare\n\nv_curr record;\n\nbegin\n\nfor v_curr in\n\n(\n\nselect deps_ddl_to_run\n\nfrom deps_saved_ddl\n\nwhere deps_view_schema = p_view_schema and deps_view_name = p_view_name\n\norder by deps_id desc\n\n) loop\n\nexecute v_curr.deps_ddl_to_run;\n\nend loop;\n\ndelete from deps_saved_ddl\n\nwhere deps_view_schema = p_view_schema and deps_view_name = p_view_name;\n\nend;\n\n$$\n\nLANGUAGE plpgsql;\n</code></pre>\n<h3>Modo de uso</h3>\n<p>deps_save_and_drop_dependencies(nombre_de_schema, nombre_de_tabla)\ndeps_restore_dependencies(nombre_de_shema, nombre_de_tabla)</p>\n<p>Fuente:\n<a href=\"https://gist.github.com/mateuszwenus/11187288\">https://gist.github.com/mateuszwenus/11187288</a></p>","frontmatter":{"title":"Guardar/Restaurar dependencias PostgreSQL","date":"January 28, 2021","frontimage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#081838","images":{"fallback":{"src":"/brain/static/f22fa2a14d28469e47c55b7a6cd9130b/decd9/frontimage.jpg","srcSet":"/brain/static/f22fa2a14d28469e47c55b7a6cd9130b/8b36d/frontimage.jpg 225w,\n/brain/static/f22fa2a14d28469e47c55b7a6cd9130b/c3ae1/frontimage.jpg 450w,\n/brain/static/f22fa2a14d28469e47c55b7a6cd9130b/decd9/frontimage.jpg 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/brain/static/f22fa2a14d28469e47c55b7a6cd9130b/5c5cf/frontimage.webp 225w,\n/brain/static/f22fa2a14d28469e47c55b7a6cd9130b/0380a/frontimage.webp 450w,\n/brain/static/f22fa2a14d28469e47c55b7a6cd9130b/42498/frontimage.webp 900w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":960,"height":299.73333333333335}}},"description":"Guardar/Restaurar dependencias PostgreSQL"},"fields":{"slug":"/008-guardar-restaurar-dependencias-postgresql/"}},"previous":{"fields":{"slug":"/009-instalacion-laravel-php-mssql/index.md/"},"frontmatter":{"title":"Laravel 8 PHP 7.4 MSSql"}},"next":{"fields":{"slug":"/007-terraform-101/"},"frontmatter":{"title":"Terraform - 101"}}},"pageContext":{"id":"5fe2a75d-0a58-5fc2-885b-ba9b41716ec3","previousPostId":"488a1c86-8dae-5f96-9d1a-18871841d7e3","nextPostId":"0af948fa-154f-5f99-a2ed-6186cdf99d82"}},
    "staticQueryHashes": ["2841359383","3865664119"]}